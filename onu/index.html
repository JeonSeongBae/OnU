<!DOCTYPE html>
<html lang="kr">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- -->
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
  </head>
  <body>
    <header>
      <nav id="header" class="navbar navbar-expand-lg navbar-dark fixed-top">
        <a class="navbar-brand" href="./index.html">
          <img src="./img/logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
          공앤유
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav justify-content-end">
            <li class="nav-item active">
              <a id = "signup_hi" class="nav-link" href="signup.html">회원가입</a>
            </li>
            <li class="nav-item active">
              <a id = "login_logout" class="nav-link" href="#" data-toggle="modal" data-target=".bd-example-modal-lg" data-whatever="login">로그인</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <div class="main-header">
      <div class="container main-container">
        <h1>공유하는 시대</h1>
        <h1>나눠쓰자 나의공간</h1>
        <br>
        <div class="current-container">
          <hr>
          <span id="current"></span>
          <hr>
        </div>
        <button type="button" id = "request" class="btn btn-default btn-lg" data-toggle="modal" data-target=".bd-example-modal-lg" data-whatever="request">
          장소견적 신청하기
        </button>
      </div>
    </div>

    <div class="main-section">
      <div class="container">
        <span>발상의 전환</span>
        <hr>
        <div class="row">
          <div class="col align-self-center">
            <p>공급자로부터 소비자가 선택하는 방식</p>
          </div>
          <div class="col">
            <img src="img/maincontent1.png" alt="">
          </div>
          <div class="col align-self-center">
            <p>소비자로부터 공급자가 선택하는 방식</p>
          </div>
        </div>

      </div>
    </div>

    <div class="main-section main-content">
      <div class="container">
        <span>공앤유를 사용하면?</span>
        <hr>
        <div class="row">
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>편리성 제공</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>생산성 향상</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>유휴공간 활용</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>합리적인 가격</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>부가수익 창출</h4>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>관리 효율화</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>사용할 공간 사진</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>실제 사용후기</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>실시간 Q&A</h4>
          </div>
          <div class="col">
            <img src="img/introduce (1).png" alt="">
            <br>
            <h4>효율성</h4>
          </div>
        </div>
      </div>
    </div>

    <div class="main-section">
      <div class="container">
        <span>공앤유의 이용방법</span>
        <hr>
        <div class="row">
          <div class="col align-self-center">
            1. 장소견적 신청하기
          </div>
          <div class="col">
            <img src="img/maincontent1.png" alt="">
          </div>
          <div class="col align-self-center">
            2. 견적 비교후 예약하기
          </div>
          <div class="col">
            <img src="img/maincontent1.png" alt="">
          </div>
          <div class="col align-self-center">
            3. 임대인과 마무리계약
          </div>
        </div>

      </div>
    </div>

    <div id="modal" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title"></span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">

          </div>
          <div class="modal-footer">

          </div>
        </div>
      </div>
    </div>
    <footer>
      <button type="button" name="button" class ="btn btn-primary" data-toggle="modal" data-target=".bd-example-modal-lg" data-whatever = "sample"> sample </button>
    </footer>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyB5Aji_Ysf6EsI_6cR4kDs3yi9s0bjo9_k",
        authDomain: "andu-3f6db.firebaseapp.com",
        databaseURL: "https://andu-3f6db.firebaseio.com",
        projectId: "andu-3f6db",
        storageBucket: "andu-3f6db.appspot.com",
        messagingSenderId: "799401536592"
      };
      firebase.initializeApp(config);
      var authdata;

      $(window).ready(function() {
        var ref = firebase.database().ref('type');
        var content = "현재까지 등록된 공간 수는 ";

        ref.once('value').then(function(snapshot) {
          var list = snapshot.val();

          for(var i in list) {
            content += i + " : " + list[i] + "개 ";
          }

          content += "입니다.";
          console.log(content);
          document.getElementById("current").innerHTML = content;

          firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
              authdata = user;
              document.getElementById('signup_hi').innerHTML = authdata.email + "님 환영합니다.";
              document.getElementById('login_logout').innerHTML = "로그아웃";

              var data = firebase.database().ref('users/consumer/');
              data.once('value').then(function(snapshot){//consumer 아이디를  currentUser와 비교
                var a = snapshot.val();
                var b = Object.keys(snapshot.val());
                for (var i = 0; i < b.length; i++) {
                  if (authdata.email == a[b[i]].email) {//consumer안에 있는 아이디라면
                    // provider_Mypage
                    document.getElementById('signup_hi').href = "./upload.html";//소비자용 마이페이지로 이동
                    document.getElementById('request').setAttribute("data-whatever", "request");
                    document.getElementById('request').innerHTML = "장소견적 신청하기";
                  }else {
                    // consummer_Mypage
                    document.getElementById('signup_hi').href = "./placeinfo.html";
                    document.getElementById('request').setAttribute("data-whatever", "array_request");
                    document.getElementById('request').innerHTML = "견적신청 내역보기";
                  }
                }
              });
            }
            else {
             authdata = null;
             document.getElementById('signup_hi').innerHTML = "회원가입";
             document.getElementById('signup_hi').href = "signup.html";
             document.getElementById('login_logout').innerHTML = "로그인";
             document.getElementById('request').innerHTML = "장소견적 신청하기";
            }
          });
        });
      });

      $(window).scroll(function() {

        if ($("#header").offset().top > 600) {
          $("#header").addClass("navbar-shrink");
        } else {
          $("#header").removeClass("navbar-shrink");
        }
      });

      var typeRef = firebase.database().ref('type');
      var typeList;

      typeRef.once('value').then(function(snapshot) {
        typeList = snapshot.val();
      });

      var placeRef = firebase.database().ref('place');
      var locationList;
      var temp;
      placeRef.once('value').then(function(snapshot) {
        locationList = snapshot.val();
      });

      $('#modal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var type = button.data('whatever');


        var modal = $(this);
        modal.find('.modal-body').text("");
        modal.find('.modal-footer').text("");

        switch (type) {
          case 'request':
            var index = 0;
            modal.find('.modal-title').text('견적서 신청하기');
            initButton($('.modal-body'), index++, "공간유형", typeList);
            initButton($('.modal-body'), index++, "지역", locationList);
            initButton($('.modal-body'), index++, "인원", null);
            initButton($('.modal-body'), index++, "날짜", null);

            var btn = document.createElement("button");
            btn.setAttribute("type", "button");
            btn.className = "btn btn-primary";
            btn.innerHTML = "신청하기";
            btn.setAttribute("onclick", "place_request()");

            modal.find('.modal-footer').append(btn);

            break;
          
          case 'login':

            if(authdata){
              firebase.auth().signOut().then(function() {
                // Sign-out successful.
                alert("로그아웃 되었습니다.");
                //이미 속성에 들어가버려서 나오는 창을 닫을 방법을 모르겠음 by 상인
                return;
              }, function(error) {
                alert(error);
                // An error happened.
              });
              return;
            }
            modal.find('.modal-title').text("로그인");

            var div = document.createElement("div");
            div.className = "row";

            var leftDiv = document.createElement("div");
            leftDiv.className = "col-8";

            var form = document.createElement("form");

            makeForm(form, "Email", "email", "email");
            makeForm(form, "비밀번호", "password", "password");

            leftDiv.appendChild(form);

            var rightDiv = document.createElement("div");
            rightDiv.className = "col-4";

            var p = document.createElement("p");
            p.innerHTML = "간편 로그인";

            var btnDiv = document.createElement("div");

            var googlebtn = document.createElement("button");
            googlebtn.innerHTML = "구글로그인 자리";

            var facebookbtn = document.createElement("button");
            facebookbtn.innerHTML = "페이스북 자리";

            var kakaobtn = document.createElement("button");
            kakaobtn.innerHTML = "카카오 자리";

            btnDiv.appendChild(googlebtn);
            btnDiv.appendChild(facebookbtn);
            btnDiv.appendChild(kakaobtn);

            rightDiv.appendChild(p);
            rightDiv.appendChild(btnDiv);

            div.appendChild(leftDiv);
            div.appendChild(rightDiv);

            modal.find('.modal-body').append(div);

            var btn = document.createElement("button");
            btn.setAttribute("type", "button");
            btn.className = "btn btn-primary";
            btn.innerHTML = "로그인";

            btn.setAttribute("onclick", "consumer_login()");

            modal.find('.modal-footer').append(btn);

            break;
          default:

        }
      });

      function get_currentUser(){
        return firebase.auth().currentUser;
      }

      function consumer_login(){
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;

        firebase.auth().signInWithEmailAndPassword(email, password).then(function(firebaseUser) {
          // Handle Errors here.
          alert("로그인에 성공하였습니다.");
          location.href = "index.html";
          // ...
        }).catch(function(error){
          var errorCode = error.code;
          var errorMessage = error.message;
            alert("로그인에 실패하였습니다.\n" + errorCode + " " + errorMessage);

        });
      }

      function logout(){
        firebase.auth().signOut().then(function() {
          // Sign-out successful.
        }, function(error) {
          console.log(error);
          // An error happened.
        });
      }

      function initButton(form, index, name, list) {
        var div = document.createElement("div");
        div.className = "form-btn";

        var type = document.createElement("button");
        type.setAttribute("type", "button");
        type.className = "btn btn-info";
        type.setAttribute("data-toggle", "collapse");
        type.setAttribute("data-target", "#formElement" + index);
        type.innerHTML = name;

        var span = document.createElement("span");
        span.className = "form-text";
        span.id = "data" + index;

        type.appendChild(span);

        var typeDiv = document.createElement("div");
        typeDiv.id = "formElement" + index;
        typeDiv.className = "collapse";

        var listDiv = setList(index, list);
        $('.selectpicker').selectpicker();

        typeDiv.appendChild(listDiv);

        div.appendChild(type);
        div.appendChild(typeDiv);

        form.append(div);
      }

      function setList(index, list) {
        switch (index) {
          case 0:
            var listDiv = document.createElement("div");
            listDiv.className = "list-group";

            for(var j in list) {
              var bt = document.createElement("button");
              bt.setAttribute("type", "button");
              bt.className = "list-group-item";
              bt.innerHTML = j;
              bt.setAttribute("onclick", "selectItem(this)");
              listDiv.appendChild(bt);
            }

            return listDiv;

          case 1:
            var listDiv = document.createElement("div");
            listDiv.className = "input-group";

            var city = makeDropdown("지역", list);
            var district = makeDropdown("선택해주세요", null);

            listDiv.appendChild(city);
            listDiv.appendChild(district);

            return listDiv;

          case 2:
            var listDiv = document.createElement("div");
            listDiv.className = "input-group";

            var text = document.createElement("input");
            text.className = "form-control";
            text.setAttribute("type", "number");
            text.setAttribute("min", "1");
            text.setAttribute("max", "1000");
            text.setAttribute("placeholder", "인원 수를 입력해주세요.");

            var span = document.createElement("span");
            span.className = "input-group-addon";
            span.innerHTML = "명";

            var bt = document.createElement("button");
            bt.setAttribute("type", "button");
            bt.className = "btn btn-default";
            bt.innerHTML = "선택하기";
            bt.style.float = "right";
            bt.setAttribute("onclick", "selectNumber(this)");

            listDiv.appendChild(text);
            listDiv.appendChild(span);
            listDiv.appendChild(bt);

            return listDiv;

          case 3:
            var listDiv = document.createElement("div");
            listDiv.className = "input-group";

            var input_date = document.createElement("input");
            input_date.setAttribute("type", "date");
            input_date.className = "form-control";

            var bt = document.createElement("button");
            bt.setAttribute("type", "button");
            bt.className = "btn btn-default";
            bt.innerHTML = "선택하기";
            bt.style.float = "right";
            bt.setAttribute("onclick", "selectDate(this)");

            listDiv.appendChild(input_date);
            listDiv.appendChild(bt);

            return listDiv;
          default:

        }
      }

      function selectItem(item) {
        var text = $(item).html();
        var temp = $(item).parents('.form-btn').find('.form-text').html();
        $(item).parents('.form-btn').find('.form-text').text(temp + " " + text);
        $('.collapse').removeClass('show');
      }

      function selectPlace(item) {
        var text = $(item).html();
        $('.city').html(text);
        $(item).parents('.form-btn').find('.form-text').text(text);

        var menu = $('.district').parents('.btn-group').find('.dropdown-menu');

        for(var index in locationList[text]) {
          var a = document.createElement("a");
          a.className = "dropdown-item";
          a.setAttribute("onclick", "selectItem(this)");
          a.innerHTML = locationList[text][index];

          menu.append(a);
        }
      }

      function selectNumber(item) {
        var text = $(item).parents('.input-group').find('.form-control').val();
        $(item).parents('.form-btn').find('.form-text').text(text + "명");
        $('.collapse').removeClass('show');
      }

      function selectDate(item){
        var text = $(item).parents('.input-group').find('.form-control').val();
        $(item).parents('.form-btn').find('.form-text').text(text + "일");
        $('.collapse').removeClass('show');
      }

      function makeDropdown(title, list) {
        var div = document.createElement("div");
        div.className = "btn-group";
        var button = document.createElement("button");
        button.className = "btn btn-secondary dropdown-toggle";
        if(list != null) {
          button.className += " city";
        } else {
          button.className += " district";
        }
        button.id = "dropdownMenuButton";
        button.setAttribute("type", "button");
        button.setAttribute("data-toggle", "dropdown");
        button.setAttribute("aria-haspopup", "true");
        button.setAttribute("aria-expanded", "false");
        button.innerHTML = title;

        var menu = document.createElement("div");
        menu.className = "dropdown-menu";
        menu.setAttribute("aria-labelledby", "dropdownMenuButton");


        for(var index in list) {
          var a = document.createElement("a");
          a.className = "dropdown-item";
          a.setAttribute("onclick", "selectPlace(this)");

          a.innerHTML = index;

          menu.appendChild(a);
        }


        div.appendChild(button);
        div.appendChild(menu);

        return div;
      }

      function makeForm(form, text, id, type) {
        var formDiv = document.createElement("div");
        formDiv.className = "form-group";

        var label = document.createElement("label");
        label.setAttribute("for", id);
        label.innerHTML = text;
        var input = document.createElement("input");
        input.setAttribute("type", type);
        input.className = "form-control";
        input.id = id;
        input.setAttribute("placeholder", text + "를 입력해주세요");
        formDiv.appendChild(label);
        formDiv.appendChild(input);

        form.appendChild(formDiv);
      }

      function place_request(){
        var type = document.getElementById("data0").innerHTML;
        var place = document.getElementById("data1").innerHTML;
        var number = document.getElementById("data2").innerHTML;
        var date = document.getElementById("data3").innerHTML;

        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            firebase.database().ref('contract/' + user.uid).set({
              type:type,
              place:place,
              number:number,
              date:date
            });
            alert("신청이 완료되었습니다. 신청하신 내용은 마이페이지에서 확인하실 수 있습니다.");
            location.href = "index.html";
          }
          else{
            alert("로그인을 해주세요");
            location.href = "index.html";
          }
      });
    }

    </script>
  </body>
</html>
